let allMovies=[],remainingMovies=[];const STORAGE_KEY='randomMoviePickerState',cfgParts=['YWNhMjE1ODUx','MTkwMGY1ZTQ5','MGI0MzIxMjkz','ZDA0MGI='],cfgJoined=cfgParts.join(''),cfgDecoded=atob(cfgJoined),csvFileInput=document.getElementById('csvFileInput'),loadButton=document.getElementById('loadButton'),pickButton=document.getElementById('pickButton'),statusText=document.getElementById('statusText'),currentSelection=document.getElementById('currentSelection'),moviePoster=document.getElementById('moviePoster'),letterboxdLink=document.getElementById('letterboxdLink');async function init(){if(window.location.protocol==='http:'||window.location.protocol==='https:'){try{await loadCSVFromURL('./watchlist.csv');return}catch(error){console.log('Could not auto-load watchlist.csv, falling back to localStorage')}}try{const storedData=localStorage.getItem(STORAGE_KEY);if(storedData){const state=JSON.parse(storedData);if(state&&Array.isArray(state.allMovies)&&Array.isArray(state.remainingMovies)&&state.allMovies.every(item=>typeof item==='object'&&item.name)){if(state.allMovies.length>0){allMovies=state.allMovies;remainingMovies=state.remainingMovies;pickButton.disabled=false;statusText.textContent=`Loaded ${allMovies.length} movies from previous session.`;return}}localStorage.removeItem(STORAGE_KEY)}}catch(error){localStorage.removeItem(STORAGE_KEY)}allMovies=[];remainingMovies=[];pickButton.disabled=true;statusText.textContent='No watchlist loaded'}function saveState(){const state={allMovies,remainingMovies};localStorage.setItem(STORAGE_KEY,JSON.stringify(state))}async function loadCSVFromURL(url){return new Promise((resolve,reject)=>{fetch(url).then(response=>{if(!response.ok){throw new Error(`HTTP error! status: ${response.status}`)}return response.text()}).then(csvText=>{Papa.parse(csvText,{header:true,skipEmptyLines:true,complete:function(results){try{if(results.data.length===0||!results.data[0].hasOwnProperty('Name')){reject(new Error('No valid movies found in CSV. Make sure there is a "Name" column.'));return}const movies=results.data.map(row=>{const name=row.Name?row.Name.trim():'';if(!name)return null;return{name:name,year:row.Year?row.Year.trim():'',letterboxdUri:row['Letterboxd URI']?row['Letterboxd URI'].trim():''}}).filter(movie=>movie!==null);if(movies.length===0){reject(new Error('No valid movies found in CSV'));return}allMovies=movies;remainingMovies=[...allMovies];statusText.textContent=`Loaded ${movies.length} movies from watchlist`;currentSelection.textContent='';letterboxdLink.style.display='none';pickButton.disabled=false;saveState();resolve()}catch(error){reject(new Error('Failed to parse CSV. Please check the file format.'))}},error:function(error){reject(new Error('Failed to parse CSV. Please check the file format.'))}})}).catch(error=>{reject(error)})})}function loadCSV(){const file=csvFileInput.files[0];if(!file){statusText.textContent='Please select a CSV file.';return}Papa.parse(file,{header:true,skipEmptyLines:true,complete:function(results){try{if(results.data.length===0||!results.data[0].hasOwnProperty('Name')){statusText.textContent='No valid movies found in CSV. Make sure there is a "Name" column.';pickButton.disabled=true;return}const movies=results.data.map(row=>{const name=row.Name?row.Name.trim():'';if(!name)return null;return{name:name,year:row.Year?row.Year.trim():'',letterboxdUri:row['Letterboxd URI']?row['Letterboxd URI'].trim():''}}).filter(movie=>movie!==null);if(movies.length===0){statusText.textContent='No valid movies found in CSV';pickButton.disabled=true;return}allMovies=movies;remainingMovies=[...allMovies];statusText.textContent=`Loaded ${movies.length} movies from ${file.name}`;currentSelection.textContent='';letterboxdLink.style.display='none';pickButton.disabled=false;saveState()}catch(error){statusText.textContent='Failed to parse CSV. Please check the file format.'}},error:function(error){statusText.textContent='Failed to parse CSV. Please check the file format.'}})}function pickRandomMovie(){if(allMovies.length===0){return}if(remainingMovies.length===0){remainingMovies=[...allMovies]}const index=Math.floor(Math.random()*remainingMovies.length);const selectedMovie=remainingMovies[index];remainingMovies.splice(index,1);displayCurrentMovie(selectedMovie);saveState()}function displayCurrentMovie(movie){let displayText=movie.name;if(movie.year){displayText+=` (${movie.year})`}currentSelection.textContent=displayText;if(movie.letterboxdUri){letterboxdLink.href=movie.letterboxdUri;letterboxdLink.style.display='inline-block'}else{letterboxdLink.style.display='none'}fetchPosterImage(movie)}async function fetchPosterImage(movie){moviePoster.style.display='none';try{const encodedTitle=encodeURIComponent(movie.name);const p=['ap','i_','ke','y'].join('');const baseUrl='https://api.themoviedb.org/3/search/movie';let searchUrl=`${baseUrl}?${p}=${cfgDecoded}&query=${encodedTitle}`;if(movie.year){searchUrl+=`&year=${movie.year}`}const response=await fetch(searchUrl);if(!response.ok){console.error(`Service error: ${response.status} ${response.statusText}`);return}const data=await response.json();if(data.results&&data.results.length>0&&data.results[0].poster_path){const posterPath=data.results[0].poster_path;const posterUrl=`https://image.tmdb.org/t/p/w342${posterPath}`;moviePoster.src=posterUrl;moviePoster.style.display='block'}else{console.log('No poster found for this movie')}}catch(error){console.error('Error fetching poster:',error)}}loadButton.addEventListener('click',loadCSV);pickButton.addEventListener('click',pickRandomMovie);init();
